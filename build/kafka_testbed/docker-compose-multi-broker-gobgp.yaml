version: "3.2"
networks:
  gobmp-gobgp:
    driver: bridge
    ipam:
      driver: default
      config:
      - subnet: 10.1.1.0/24
services:
  gobmp:
    #image: sbezverk/gobmp:v1.0.3
    image: sbezverk/gobmp:test-235
    expose:
      - 5000
    entrypoint:
      [ 
        "/gobmp",
        "--source-port=5000",
        "--intercept=false",
        "--split-af=true",
        "--v=9",
        "--kafka-server=kafka-1:9091,kafka-2:9092,kafka-3:9093,kafka-4:9094"
      ]
    cap_add:
    - NET_ADMIN
    networks:
      gobmp-gobgp:
        ipv4_address: 10.1.1.2
    depends_on:
      - kafka-1
      - kafka-2
      - kafka-3
      - kafka-4
  zookeeper:
    image: zookeeper:3.7.0
    restart: always
    expose:
      - 2181
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      gobmp-gobgp:
        ipv4_address: 10.1.1.5
    volumes:
      - ./zookeeper_hc.sh:/tmp/hc.sh
    healthcheck:
      test: [ "CMD-SHELL", "/tmp/hc.sh" ]
      interval: 2s
      timeout: 5s
      retries: 5
      start_period: 20s
  kafka-1:
    image: confluentinc/cp-kafka:7.3.1
    restart: always
    depends_on:
      - zookeeper
    expose:
      - 9091
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: "zookeeper:2181"
      ZOOKEEPER: "zookeeper:2181"
      KAFKA_TOPICS: "gobmp.parsed.peer:4:4:delete gobmp.parsed.unicast_prefix:6:4:delete gobmp.parsed.unicast_prefix_v4:6:4:delete gobmp.parsed.unicast_prefix_v6:6:4:delete gobmp.parsed.ls_node:4:4:delete gobmp.parsed.ls_link:4:4:delete gobmp.parsed.l3vpn:4:4:delete gobmp.parsed.l3vpn_v4:4:4:delete gobmp.parsed.l3vpn_v6:4:4:delete gobmp.parsed.sr_policy:4:4:delete gobmp.parsed.sr_policy_v4:4:4:delete gobmp.parsed.sr_policy_v6:4:4:delete gobmp.parsed.flowspec:4:4:delete gobmp.parsed.flowspec_v4:4:4:delete gobmp.parsed.flowspec_v6:4:4:delete gobmp.parsed.ls_prefix:4:4:delete gobmp.parsed.ls_srv6_sid:4:4:delete gobmp.parsed.evpn:4:4:delete gobmp.parsed.statistics:4:4:delete"
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false"
      ALLOW_PLAINTEXT_LISTENER: "yes"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka-1:9091"
      KAFKA_LISTENERS: "PLAINTEXT://0.0.0.0:9091"
      BOOTSTRAP_SERVERS: "kafka-1:9091,kafka-2:9092,kafka-3:9093,kafka-4:9094"
    networks:
      gobmp-gobgp:
        ipv4_address: 10.1.1.6
    healthcheck:
      test: ps augwwx | egrep [S]upportedKafka
      interval: 2s
      timeout: 5s
      retries: 5
      start_period: 20s
  kafka-2:
    image: confluentinc/cp-kafka:7.3.1
    restart: always
    depends_on:
      - zookeeper
    expose:
      - 9092
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: "zookeeper:2181"
      ZOOKEEPER: "zookeeper:2181"
      KAFKA_TOPICS: "gobmp.parsed.peer:4:4:delete gobmp.parsed.unicast_prefix:6:4:delete gobmp.parsed.unicast_prefix_v4:6:4:delete gobmp.parsed.unicast_prefix_v6:6:4:delete gobmp.parsed.ls_node:4:4:delete gobmp.parsed.ls_link:4:4:delete gobmp.parsed.l3vpn:4:4:delete gobmp.parsed.l3vpn_v4:4:4:delete gobmp.parsed.l3vpn_v6:4:4:delete gobmp.parsed.sr_policy:4:4:delete gobmp.parsed.sr_policy_v4:4:4:delete gobmp.parsed.sr_policy_v6:4:4:delete gobmp.parsed.flowspec:4:4:delete gobmp.parsed.flowspec_v4:4:4:delete gobmp.parsed.flowspec_v6:4:4:delete gobmp.parsed.ls_prefix:4:4:delete gobmp.parsed.ls_srv6_sid:4:4:delete gobmp.parsed.evpn:4:4:delete gobmp.parsed.statistics:4:4:delete"
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false"
      ALLOW_PLAINTEXT_LISTENER: "yes"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka-2:9092"
      KAFKA_LISTENERS: "PLAINTEXT://0.0.0.0:9092"
      BOOTSTRAP_SERVERS: "kafka-1:9091,kafka-2:9092,kafka-3:9093,kafka-4:9094"
    networks:
      gobmp-gobgp:
        ipv4_address: 10.1.1.7
    healthcheck:
      test: ps augwwx | egrep [S]upportedKafka
      interval: 2s
      timeout: 5s
      retries: 5
      start_period: 20s
  kafka-3:
    image: confluentinc/cp-kafka:7.3.1
    restart: always
    depends_on:
      - zookeeper
    expose:
      - 9093
    environment:
      KAFKA_BROKER_ID: 3
      KAFKA_ZOOKEEPER_CONNECT: "zookeeper:2181"
      ZOOKEEPER: "zookeeper:2181"
      KAFKA_TOPICS: "gobmp.parsed.peer:4:4:delete gobmp.parsed.unicast_prefix:6:4:delete gobmp.parsed.unicast_prefix_v4:6:4:delete gobmp.parsed.unicast_prefix_v6:6:4:delete gobmp.parsed.ls_node:4:4:delete gobmp.parsed.ls_link:4:4:delete gobmp.parsed.l3vpn:4:4:delete gobmp.parsed.l3vpn_v4:4:4:delete gobmp.parsed.l3vpn_v6:4:4:delete gobmp.parsed.sr_policy:4:4:delete gobmp.parsed.sr_policy_v4:4:4:delete gobmp.parsed.sr_policy_v6:4:4:delete gobmp.parsed.flowspec:4:4:delete gobmp.parsed.flowspec_v4:4:4:delete gobmp.parsed.flowspec_v6:4:4:delete gobmp.parsed.ls_prefix:4:4:delete gobmp.parsed.ls_srv6_sid:4:4:delete gobmp.parsed.evpn:4:4:delete gobmp.parsed.statistics:4:4:delete"
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false"
      ALLOW_PLAINTEXT_LISTENER: "yes"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka-3:9093"
      KAFKA_LISTENERS: "PLAINTEXT://0.0.0.0:9093"
      BOOTSTRAP_SERVERS: "kafka-1:9091,kafka-2:9092,kafka-3:9093,kafka-4:9094"
    networks:
      gobmp-gobgp:
        ipv4_address: 10.1.1.8
    healthcheck:
      test: ps augwwx | egrep [S]upportedKafka
      interval: 2s
      timeout: 5s
      retries: 5
      start_period: 20s
  kafka-4:
    image: confluentinc/cp-kafka:7.3.1
    restart: always
    depends_on:
      - zookeeper
    expose:
      - 9094
    environment:
      KAFKA_BROKER_ID: 4
      KAFKA_ZOOKEEPER_CONNECT: "zookeeper:2181"
      ZOOKEEPER: "zookeeper:2181"
      KAFKA_TOPICS: "gobmp.parsed.peer:4:4:delete gobmp.parsed.unicast_prefix:6:4:delete gobmp.parsed.unicast_prefix_v4:6:4:delete gobmp.parsed.unicast_prefix_v6:6:4:delete gobmp.parsed.ls_node:4:4:delete gobmp.parsed.ls_link:4:4:delete gobmp.parsed.l3vpn:4:4:delete gobmp.parsed.l3vpn_v4:4:4:delete gobmp.parsed.l3vpn_v6:4:4:delete gobmp.parsed.sr_policy:4:4:delete gobmp.parsed.sr_policy_v4:4:4:delete gobmp.parsed.sr_policy_v6:4:4:delete gobmp.parsed.flowspec:4:4:delete gobmp.parsed.flowspec_v4:4:4:delete gobmp.parsed.flowspec_v6:4:4:delete gobmp.parsed.ls_prefix:4:4:delete gobmp.parsed.ls_srv6_sid:4:4:delete gobmp.parsed.evpn:4:4:delete gobmp.parsed.statistics:4:4:delete"
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false"
      ALLOW_PLAINTEXT_LISTENER: "yes"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka-4:9094"
      KAFKA_LISTENERS: "PLAINTEXT://0.0.0.0:9094"
      BOOTSTRAP_SERVERS: "kafka-1:9091,kafka-2:9092,kafka-3:9093,kafka-4:9094"
    networks:
      gobmp-gobgp:
        ipv4_address: 10.1.1.9
    healthcheck:
      test: ps augwwx | egrep [S]upportedKafka
      interval: 2s
      timeout: 5s
      retries: 5
      start_period: 20s
  gobgp-1:
    image: test/gobgp:3.20.0
    restart: always
    expose:
    - 179
    volumes:
    - ./gobgp/configs/gobgp1.conf:/etc/gobgp/gobgp.tmpl
    command: [ "/init.sh" ]
    healthcheck:
      test: [ "CMD-SHELL", "/tmp/hc.sh" ]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      gobmp-gobgp:
        ipv4_address: 10.1.1.3
  gobgp-2:
    image: test/gobgp:3.20.0
    restart: always
    expose:
    - 179
    volumes:
    - ./gobgp/configs/gobgp2.conf:/etc/gobgp/gobgp.tmpl
    command: [ "/init.sh" ]
    healthcheck:
      test: [ "CMD-SHELL", "/tmp/hc.sh" ]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      gobmp-gobgp:
        ipv4_address: 10.1.1.4
