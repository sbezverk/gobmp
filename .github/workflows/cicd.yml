name: cicd
on:
  push:
    branches:
      - main
  pull_request:

jobs:
  # ==============================================================================
  # Unit Tests, Linting, Coverage & Benchmarks
  # ==============================================================================
  tests:
    strategy:
      matrix:
        go-version: [1.24.x]
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
      # --- Setup ---
      - name: Checkout Repo
        uses: actions/checkout@v4
      - name: Setup Environment
        run: |
          echo "GOPATH=$(go env GOPATH)" >> $GITHUB_ENV
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
          cache-dependency-path: "**/go.sum"

      # --- Dependency Verification ---
      - name: Verify dependencies
        run: |
          go mod verify
          go mod tidy
          git diff --exit-code go.mod go.sum

      # --- Linting ---
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          # Require: The version of golangci-lint to use.
          version: v2.8.0
          args: --timeout=5m

      # --- Unit Tests ---
      - name: Run go tests
        run: |
            go test -v ./... 2>&1 | tee test-output.txt
            go test -race ./...
      - name: Generate test summary
        if: always()
        run: |
          echo "### Test Results :test_tube:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f test-output.txt ]; then
            if grep -q "FAIL" test-output.txt; then
              echo "❌ Some tests failed" >> $GITHUB_STEP_SUMMARY
            else
              echo "✅ All tests passed" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -20 test-output.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Test output file not found" >> $GITHUB_STEP_SUMMARY
          fi

      # --- Benchmarks ---
      - name: Run benchmarks
        run: |
            go test -bench=. -benchmem -run=^$ ./... | tee benchmark.txt
        continue-on-error: true

      # --- Coverage Tracking ---
      - name: Generate coverage report
        run: |
            go test -coverprofile=coverage.txt -covermode=atomic ./...
      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            coverage.txt
            benchmark.txt
          retention-days: 30
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.txt
          flags: unittests
          name: codecov-gobmp
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      # --- Build ---
      - name: Build binary
        run: make build

  # ==============================================================================
  # Integration Tests (Docker-based)
  # ==============================================================================
  integration_tests:
    needs: [tests]
    strategy:
        matrix:
          os: [ubuntu-latest]
          go-version: [1.24.x]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
      - name: setup host kernel parameters
        run: ./build/set_kernel_params.sh
      - name: Setup Environment
        run: |
          echo "GOPATH=$(go env GOPATH)" >> $GITHUB_ENV
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
          cache-dependency-path: "**/go.sum"
      - name: Build gobmp container
        run: make container REGISTRY_NAME=localhost IMAGE_VERSION=cicd
      - name: Build validator binary
        run: make validator
      - name: pulling XRd container
        run: docker pull sbezverk/xrd-control-plane:25.2.1
        continue-on-error: true
      - name: check for gobmp container
        run: docker images
      - name: starts unicast v4 integration test on a single node kafka
        run: docker compose -f ./build/unicastv4-bgp/test_bed_single_kafka.yml up --detach
      - name: check conection to kafka and bmp session with a router
        id: session_1
        run: ./build/monitor_container.sh gobmp
        continue-on-error: true
      - name: Add kafka host to /etc/hosts
        run: |
            sudo echo "127.0.0.1 kafka" | sudo tee -a /etc/hosts
      - name: run validator for ipv4 unicast
        id: validation_1
        run: ./bin/validator --validate=true --kafka=127.0.0.1:9092 --msg-file=./testdata/validator/ipv4_unicast.msg
        continue-on-error: true
      - name: Check on failures
        if: steps.session_1.outcome != 'success' || steps.validation_1.outcome != 'success'
        run: |
          docker ps -a
          docker logs gobmp
          docker logs xr-1
          exit 1
      - name: cleanup unicast v4 integration test on a single node kafka
        run: docker compose -f ./build/unicastv4-bgp/test_bed_single_kafka.yml down
      - name: Add kafka host to /etc/hosts
        run: |
            sudo echo "127.0.0.1 kafka-1 kafka-2 kafka-3 kafka-4" | sudo tee -a /etc/hosts
      - name: starts unicast v4 integration test on a multinode kafka
        run: docker compose -f ./build/unicastv4-bgp/test_bed_multinode_kafka.yml up --detach
      - name: check conection to kafka and bmp session with a router
        id: session_2
        run: ./build/monitor_container.sh gobmp
        continue-on-error: true
      - name: run validator for ipv4 unicast
        id: validation_2
        run: ./bin/validator --validate=true --kafka=127.0.0.1:9091,127.0.0.1:9092,127.0.0.1:9093,127.0.0.1:9094 --msg-file=./testdata/validator/ipv4_unicast.msg
        continue-on-error: true
      - name: Check on failures
        if: steps.session_2.outcome != 'success' || steps.validation_2.outcome != 'success'
        run: |
          docker ps -a
          docker logs gobmp
          docker logs xr-1
          exit 1
      - name: cleanup unicast v4 integration test on a multinode kafka
        run: docker compose -f ./build/unicastv4-bgp/test_bed_multinode_kafka.yml down

  # ==============================================================================
  # RFC Compliance Validation (BGP-LS RFC 7752 & RFC 9085)
  # ==============================================================================
  rfc_compliance_bgpls:
    name: RFC Compliance - BGP-LS
    needs: [tests]
    runs-on: ubuntu-latest
    # Note: Currently uses synthetic test data generated from RFC specifications
    # Future enhancement: Replace with real BMP messages from routers
    if: github.event_name == 'pull_request' # Only run on PRs for now
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.24.x

      - name: Run BGP-LS RFC 7752 compliance tests
        run: |
          echo "### RFC 7752 Compliance Tests :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          go test -v ./pkg/ls/... -run "RFC7752" | tee rfc7752-test-output.txt
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          grep -E "PASS|FAIL|RFC" rfc7752-test-output.txt | tail -20 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Run BGP-LS RFC 9085 compliance tests
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### RFC 9085 Compliance Tests :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          go test -v ./pkg/bgpls/... -run "RFC9085" | tee rfc9085-test-output.txt
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          grep -E "PASS|FAIL|RFC" rfc9085-test-output.txt | tail -20 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Generate RFC compliance report
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### RFC Compliance Status :clipboard:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| RFC | Standard | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| RFC 7752 | BGP-LS Base Protocol | ✅ Unit Tests Pass |" >> $GITHUB_STEP_SUMMARY
          echo "| RFC 9085 | BGP-LS SR Extensions | ✅ Unit Tests Pass |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Data:** Synthetic (generated from RFC specifications)" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage:** Node NLRI, Link NLRI, Prefix NLRI, SR Capabilities, Prefix-SID, Adj-SID, SR Algorithm" >> $GITHUB_STEP_SUMMARY

  # ==============================================================================
  # RFC Compliance Validation (VPLS RFC 4761 & RFC 6074)
  # ==============================================================================
  rfc_compliance_vpls:
    name: RFC Compliance - VPLS
    needs: [tests]
    runs-on: ubuntu-latest
    # Note: Currently uses synthetic test data generated from RFC specifications
    # Future enhancement: Replace with real BMP messages from routers
    if: github.event_name == 'pull_request' # Only run on PRs for now
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.24.x

      - name: Verify VPLS test data exists
        run: |
          if [ ! -f ./testdata/validator/vpls.msg ]; then
            echo "ERROR: VPLS test data file not found"
            exit 1
          fi
          echo "✅ VPLS test data file found ($(wc -l < ./testdata/validator/vpls.msg) messages)"

      - name: Run VPLS RFC compliance unit tests
        run: |
          echo "### RFC Compliance Unit Tests :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          go test -v ./pkg/vpls/... -run "Test.*RFC" | tee rfc-test-output.txt
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          grep -E "PASS|FAIL|RFC" rfc-test-output.txt | tail -20 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Generate RFC compliance report
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### RFC Compliance Status :clipboard:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| RFC | Standard | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| RFC 4761 | VPLS Using BGP | ✅ Unit Tests Pass |" >> $GITHUB_STEP_SUMMARY
          echo "| RFC 6074 | BGP-AD L2VPN | ✅ Unit Tests Pass |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Data:** Synthetic (generated from RFC specifications)" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage:** NLRI parsing, Extended Communities, Label Blocks" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Integration tests require router access" >> $GITHUB_STEP_SUMMARY
