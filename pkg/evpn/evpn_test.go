package evpn

import (
	"reflect"
	"testing"

	"github.com/sbezverk/gobmp/pkg/base"
)

func TestUnmarshalEVPNNLRI(t *testing.T) {
	esi, _ := MakeESI([]byte{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00})
	esi2, _ := MakeESI([]byte{0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10})
	esi3, _ := MakeESI([]byte{0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11})
	mac, _ := MakeMACAddress([]byte{0x00, 0x81, 0xc4, 0xbc, 0x77, 0x8a})
	mac2, _ := MakeMACAddress([]byte{0x00, 0x81, 0xc4, 0xbc, 0x77, 0x8a})
	rd, _ := base.MakeRD([]byte{0x00, 0x01, 0xac, 0x1f, 0x65, 0x06, 0x00, 0x00})
	tests := []struct {
		name   string
		input  []byte
		expect *Route
	}{
		{
			name:  "real type 3 route nlri",
			input: []byte{0x03, 0x11, 0x00, 0x00, 0x00, 0xc8, 0x00, 0x00, 0x00, 0x32, 0x00, 0x00, 0x00, 0x00, 0x20, 0xac, 0x1f, 0x65, 0x06},
			expect: &Route{
				Route: []*NLRI{
					{
						RouteType: 3,
						Length:    17,
						RouteTypeSpec: &InclusiveMulticastEthTag{
							RD: &base.RD{
								Type:  0,
								Value: []byte{0x00, 0xc8, 0x00, 0x00, 0x00, 0x32},
							},
							EthTag:       []byte{0, 0, 0, 0},
							IPAddrLength: 32,
							IPAddr:       []byte{172, 31, 101, 6},
						},
					},
				},
			},
		},
		{
			name:  "real type 2 route nlri",
			input: []byte{0x02, 0x21, 0x00, 0x00, 0x00, 0xc8, 0x00, 0x00, 0x00, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x00, 0x81, 0xc4, 0xbc, 0x77, 0x8a, 0x00, 0x18, 0xa9, 0x71},
			expect: &Route{
				Route: []*NLRI{
					{
						RouteType: 2,
						Length:    33,
						RouteTypeSpec: &MACIPAdvertisement{
							RD: &base.RD{
								Type:  0,
								Value: []byte{0x00, 0xc8, 0x00, 0x00, 0x00, 0x32},
							},
							ESI:           esi,
							EthTag:        []byte{0, 0, 0, 0},
							MACAddrLength: 48,
							MACAddr:       mac,
							IPAddrLength:  0,
							Label: []*base.Label{
								{
									Value: 101015,
									Exp:   0,
									BoS:   true,
								},
							},
						},
					},
				},
			},
		},
		{
			name:  "real type 1 route nlri",
			input: []byte{0x01, 0x19, 0x00, 0x00, 0x00, 0xc8, 0x00, 0x00, 0x00, 0x32, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00, 0x18, 0xa9, 0xb1},
			expect: &Route{
				Route: []*NLRI{
					{
						RouteType: 1,
						Length:    0x19,
						RouteTypeSpec: &EthAutoDiscovery{
							RD: &base.RD{
								Type:  0,
								Value: []byte{0x00, 0xc8, 0x00, 0x00, 0x00, 0x32},
							},
							ESI:    esi3,
							EthTag: []byte{0, 0, 0, 0},
							Label: []*base.Label{
								{
									Value: 101019,
									Exp:   0,
									BoS:   true,
								},
							},
						},
					},
				},
			},
		},
		{
			name:  "real type 4 route nlri",
			input: []byte{0x04, 0x17, 0x00, 0x01, 0xac, 0x1f, 0x65, 0x06, 0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x20, 0xac, 0x1f, 0x65, 0x06},
			expect: &Route{
				Route: []*NLRI{
					{
						RouteType: 4,
						Length:    0x17,
						RouteTypeSpec: &EthernetSegment{
							RD:           rd,
							ESI:          esi3,
							IPAddrLength: 32,
							IPAddr:       []byte{0xac, 0x1f, 0x65, 0x06},
						},
					},
				},
			},
		},
		{
			name:  "real type 3 route nlri",
			input: []byte{0x02, 0x28, 0x00, 0x00, 0x00, 0xc8, 0x00, 0x00, 0x00, 0x32, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x30, 0x00, 0x81, 0xc4, 0xbc, 0x77, 0x8a, 0x20, 0x0a, 0x0a, 0x0a, 0x01, 0x18, 0xa9, 0x71, 0x18, 0xa9, 0x11, 0x02, 0x21, 0x00, 0x00, 0x00, 0xc8, 0x00, 0x00, 0x00, 0x32, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x30, 0x00, 0x81, 0xc4, 0xbc, 0x77, 0x8a, 0x00, 0x18, 0xa9, 0x71},
			expect: &Route{
				Route: []*NLRI{
					{
						RouteType: 2,
						Length:    40,
						RouteTypeSpec: &MACIPAdvertisement{
							RD: &base.RD{
								Type:  0,
								Value: []byte{0x00, 0xc8, 0x00, 0x00, 0x00, 0x32},
							},
							ESI:           esi2,
							EthTag:        []byte{0, 0, 0, 0},
							MACAddrLength: 48,
							MACAddr:       mac2,
							IPAddrLength:  32,
							IPAddr:        []byte{10, 10, 10, 1},
							Label: []*base.Label{
								{
									Value: 101015,
									Exp:   0,
									BoS:   true,
								},
								{
									Value: 101009,
									Exp:   0,
									BoS:   true,
								},
							},
						},
					},
					{
						RouteType: 2,
						Length:    33,
						RouteTypeSpec: &MACIPAdvertisement{
							RD: &base.RD{
								Type:  0,
								Value: []byte{0x00, 0xc8, 0x00, 0x00, 0x00, 0x32},
							},
							ESI:           esi2,
							EthTag:        []byte{0, 0, 0, 0},
							MACAddrLength: 48,
							MACAddr:       mac2,
							IPAddrLength:  0,
							Label: []*base.Label{
								{
									Value: 101015,
									Exp:   0,
									BoS:   true,
								},
							},
						},
					},
				},
			},
		},
		{
			name:  "real type 5 route nlri",
			input: []byte{0x05, 0x22, 0x00, 0x01, 0x0A, 0x22, 0x04, 0x01, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x0A, 0x0A, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xFC, 0x05, 0x22, 0x00, 0x01, 0x0A, 0x22, 0x04, 0x01, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x14, 0x14, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xFC},
			expect: &Route{
				Route: []*NLRI{
					{
						RouteType: 5,
						Length:    34,
						RouteTypeSpec: &IPPrefix{
							RD: &base.RD{
								Type:  1,
								Value: []byte{0x0A, 0x22, 0x04, 0x01, 0x00, 0x03},
							},
							ESI:          esi,
							EthTag:       []byte{0, 0, 0, 0},
							IPAddrLength: 24,
							IPAddr:       []byte{10, 10, 10, 0},
							GWIPAddr:     []byte{0, 0, 0, 0},
							Label: []*base.Label{
								{
									Value: 63,
									Exp:   6,
									BoS:   false,
								},
							},
						},
					},
					{
						RouteType: 5,
						Length:    34,
						RouteTypeSpec: &IPPrefix{
							RD: &base.RD{
								Type:  1,
								Value: []byte{0x0A, 0x22, 0x04, 0x01, 0x00, 0x03},
							},
							ESI:          esi,
							EthTag:       []byte{0, 0, 0, 0},
							IPAddrLength: 24,
							IPAddr:       []byte{20, 20, 20, 0},
							GWIPAddr:     []byte{0, 0, 0, 0},
							Label: []*base.Label{
								{
									Value: 63,
									Exp:   6,
									BoS:   false,
								},
							},
						},
					},
				},
			},
		},
		{
			name:  "real type 5 route nlri",
			input: []byte{0x05, 0x3A, 0x00, 0x01, 0x0A, 0x22, 0x04, 0x01, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x20, 0x01, 0x0D, 0xB8, 0x00, 0x00, 0x00, 0x0B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xFC},
			expect: &Route{
				Route: []*NLRI{
					{
						RouteType: 5,
						Length:    58,
						RouteTypeSpec: &IPPrefix{
							RD: &base.RD{
								Type:  1,
								Value: []byte{0x0A, 0x22, 0x04, 0x01, 0x00, 0x03},
							},
							ESI:          esi,
							EthTag:       []byte{0, 0, 0, 0},
							IPAddrLength: 64,
							IPAddr:       []byte{32, 1, 13, 184, 0, 0, 0, 11, 0, 0, 0, 0, 0, 0, 0, 0},
							GWIPAddr:     []byte{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
							Label: []*base.Label{
								{
									Value: 63,
									Exp:   6,
									BoS:   false,
								},
							},
						},
					},
				},
			},
		},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			got, err := UnmarshalEVPNNLRI(tt.input)
			if err != nil {
				t.Fatalf("test failed with error: %+v", err)
			}
			if !reflect.DeepEqual(tt.expect, got) {
				t.Fatalf("test failed as expected nlri %+v does not match actual nlri %+v", tt.expect, got)
			}
		})
	}
}
